<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        MalwareTech Challenge #5 Write-Ups ::
        Reversing Stories
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="[ Shellcode ]#Shellcode1#Hi, now we are given a PE file shellcode2.exe_ .
Description:
 shellcode2.exe contains a flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?
 Rules &amp;amp; Information:
  You are not require to run shellcode2.exe, this challenge is static analysis only. Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/malwaretech-chal5/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MalwareTech Challenge #5 Write-Ups"/>
<meta name="twitter:description" content="[ Shellcode ]#Shellcode1#Hi, now we are given a PE file shellcode2.exe_ .
Description:
 shellcode2.exe contains a flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?
 Rules &amp; Information:
  You are not require to run shellcode2.exe, this challenge is static analysis only. Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating."/>



<meta property="og:title" content="MalwareTech Challenge #5 Write-Ups" />
<meta property="og:description" content="[ Shellcode ]#Shellcode1#Hi, now we are given a PE file shellcode2.exe_ .
Description:
 shellcode2.exe contains a flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?
 Rules &amp; Information:
  You are not require to run shellcode2.exe, this challenge is static analysis only. Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/malwaretech-chal5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-30T12:02:46+07:00" />
<meta property="article:modified_time" content="2022-05-30T12:02:46+07:00" /><meta property="og:site_name" content="Reversing Stories" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">MalwareTech Challenge #5 Write-Ups</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-05-30
        </span>

        
          
        
      

      


      
    </div>

    

    

    <div class="post-content">
      
      <h2 id="-shellcode-">
  [ Shellcode ]
  <a href="#-shellcode-" class="h-anchor" aria-hidden="true">#</a>
</h2>
<h3 id="shellcode1">
  Shellcode1
  <a href="#shellcode1" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Hi, now we are given a PE file <em>shellcode2.exe_</em> .</p>
<p>Description:</p>
<blockquote>
<p>shellcode2.exe contains a flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>Rules &amp; Information:</p>
<blockquote>
<ul>
<li>You are not require to run shellcode2.exe, this challenge is static analysis only.</li>
<li>Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating.</li>
<li>Analysis can be done using the free version of IDA Pro (you donâ€™t need the debugger).</li>
</ul>
</blockquote>
<p><em>detect it easy</em> result:</p>
<p><img src="Snipaste_2022-05-30_12-14-17.jpg" alt="pic1"></p>
<p>I opened in Ghidra and found only one function recognized by Ghidra, that is entrypoint function and here is the result of Ghidra&rsquo;s decompiler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span> MD5<span style="color:#f92672">::</span>MD5(local_bc);
</span></span><span style="display:flex;"><span> local_2c <span style="color:#f92672">=</span> (code)<span style="color:#ae81ff">0x12</span>;
</span></span><span style="display:flex;"><span> local_2b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x24</span>;
</span></span><span style="display:flex;"><span> local_2a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x28</span>;
</span></span><span style="display:flex;"><span> local_29 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34</span>;
</span></span><span style="display:flex;"><span> local_28 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5b</span>;
</span></span><span style="display:flex;"><span> local_27 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x23</span>;
</span></span><span style="display:flex;"><span> local_26 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x26</span>;
</span></span><span style="display:flex;"><span> local_25 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span> local_24 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x35</span>;
</span></span><span style="display:flex;"><span> local_23 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x37</span>;
</span></span><span style="display:flex;"><span> local_22 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4c</span>;
</span></span><span style="display:flex;"><span> local_21 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x28</span>;
</span></span><span style="display:flex;"><span> local_20 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x76</span>;
</span></span><span style="display:flex;"><span> local_1f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x26</span>;
</span></span><span style="display:flex;"><span> local_1e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x33</span>;
</span></span><span style="display:flex;"><span> local_1d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x37</span>;
</span></span><span style="display:flex;"><span> local_1c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3a</span>;
</span></span><span style="display:flex;"><span> local_1b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x27</span>;
</span></span><span style="display:flex;"><span> local_1a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3d</span>;
</span></span><span style="display:flex;"><span> local_19 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6e</span>;
</span></span><span style="display:flex;"><span> local_18 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x25</span>;
</span></span><span style="display:flex;"><span> local_17 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>;
</span></span><span style="display:flex;"><span> local_16 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6f</span>;
</span></span><span style="display:flex;"><span> local_15 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3c</span>;
</span></span><span style="display:flex;"><span> local_14 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x58</span>;
</span></span><span style="display:flex;"><span> local_13 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3a</span>;
</span></span><span style="display:flex;"><span> local_12 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x68</span>;
</span></span><span style="display:flex;"><span> local_11 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2c</span>;
</span></span><span style="display:flex;"><span> local_10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x43</span>;
</span></span><span style="display:flex;"><span> local_f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x73</span>;
</span></span><span style="display:flex;"><span> local_e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span> local_d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe</span>;
</span></span><span style="display:flex;"><span> local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span> local_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6b</span>;
</span></span><span style="display:flex;"><span> local_a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span> local_9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6f</span>;
</span></span><span style="display:flex;"><span> dwBytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span> dwFlags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span> hHeap <span style="color:#f92672">=</span> GetProcessHeap();
</span></span><span style="display:flex;"><span> local_8 <span style="color:#f92672">=</span> (code <span style="color:#f92672">**</span>)HeapAlloc(hHeap,dwFlags,dwBytes);
</span></span><span style="display:flex;"><span> <span style="color:#f92672">*</span>local_8 <span style="color:#f92672">=</span> LoadLibraryA_exref;
</span></span><span style="display:flex;"><span> local_8[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> GetProcAddress_exref;
</span></span><span style="display:flex;"><span> local_8[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_2c;
</span></span><span style="display:flex;"><span> local_8[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x24</span>;
</span></span><span style="display:flex;"><span> _Dst <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)VirtualAlloc((LPVOID)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x248</span>,<span style="color:#ae81ff">0x1000</span>,<span style="color:#ae81ff">0x40</span>);
</span></span><span style="display:flex;"><span> memcpy(_Dst,<span style="color:#f92672">&amp;</span>DAT_00404040,<span style="color:#ae81ff">0x248</span>);
</span></span><span style="display:flex;"><span> (<span style="color:#f92672">*</span>_Dst)(local_8);
</span></span><span style="display:flex;"><span> lpText <span style="color:#f92672">=</span> MD5<span style="color:#f92672">::</span>digestString(local_bc,<span style="color:#f92672">&amp;</span>local_2c);
</span></span><span style="display:flex;"><span> MessageBoxA((HWND)<span style="color:#ae81ff">0x0</span>,lpText,<span style="color:#e6db74">&#34;We</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">ve been compromised!&#34;</span>,<span style="color:#ae81ff">0x30</span>);
</span></span><span style="display:flex;"><span>                   <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span> ExitProcess(<span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>Let&rsquo;s break it down!!!</p>
<p><em>First</em>, we have a byte array that is stored in stack memory and i guessed this is encrypted data, so i named <strong>encrypted_data</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span> <span style="color:#75715e">// i guessed this is an encrypted data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> local_2c <span style="color:#f92672">=</span> (code)<span style="color:#ae81ff">0x12</span>;
</span></span><span style="display:flex;"><span> local_2b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x24</span>;
</span></span><span style="display:flex;"><span> local_2a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x28</span>;
</span></span><span style="display:flex;"><span> local_29 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x34</span>;
</span></span><span style="display:flex;"><span> local_28 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5b</span>;
</span></span><span style="display:flex;"><span> local_27 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x23</span>;
</span></span><span style="display:flex;"><span> local_26 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x26</span>;
</span></span><span style="display:flex;"><span> local_25 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span> local_24 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x35</span>;
</span></span><span style="display:flex;"><span> local_23 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x37</span>;
</span></span><span style="display:flex;"><span> local_22 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4c</span>;
</span></span><span style="display:flex;"><span> local_21 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x28</span>;
</span></span><span style="display:flex;"><span> local_20 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x76</span>;
</span></span><span style="display:flex;"><span> local_1f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x26</span>;
</span></span><span style="display:flex;"><span> local_1e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x33</span>;
</span></span><span style="display:flex;"><span> local_1d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x37</span>;
</span></span><span style="display:flex;"><span> local_1c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3a</span>;
</span></span><span style="display:flex;"><span> local_1b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x27</span>;
</span></span><span style="display:flex;"><span> local_1a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3d</span>;
</span></span><span style="display:flex;"><span> local_19 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6e</span>;
</span></span><span style="display:flex;"><span> local_18 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x25</span>;
</span></span><span style="display:flex;"><span> local_17 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>;
</span></span><span style="display:flex;"><span> local_16 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6f</span>;
</span></span><span style="display:flex;"><span> local_15 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3c</span>;
</span></span><span style="display:flex;"><span> local_14 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x58</span>;
</span></span><span style="display:flex;"><span> local_13 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3a</span>;
</span></span><span style="display:flex;"><span> local_12 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x68</span>;
</span></span><span style="display:flex;"><span> local_11 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2c</span>;
</span></span><span style="display:flex;"><span> local_10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x43</span>;
</span></span><span style="display:flex;"><span> local_f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x73</span>;
</span></span><span style="display:flex;"><span> local_e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span> local_d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe</span>;
</span></span><span style="display:flex;"><span> local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span> local_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6b</span>;
</span></span><span style="display:flex;"><span> local_a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span> local_9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6f</span>;
</span></span></code></pre></div><p><em>Second</em>, we have an allocated heap memory stored in <strong>local_8</strong> that stores some data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>dwBytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span>dwFlags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>hHeap <span style="color:#f92672">=</span> GetProcessHeap();
</span></span><span style="display:flex;"><span>local_8 <span style="color:#f92672">=</span> (code <span style="color:#f92672">**</span>)HeapAlloc(hHeap,dwFlags,dwBytes);
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>local_8 <span style="color:#f92672">=</span> LoadLibraryA_exref;
</span></span><span style="display:flex;"><span>local_8[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> GetProcAddress_exref;
</span></span><span style="display:flex;"><span>local_8[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_2c;
</span></span><span style="display:flex;"><span>local_8[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x24</span>;
</span></span></code></pre></div><p>This allocated heap memory has size 0x10 byte or 4 DWORD that stores:</p>
<ul>
<li>#1 DWORD stores LoadLibraryA address</li>
<li>#2 DWORD stores GetProcAddress address</li>
<li>#3 DWORD stores <strong>encrypted_data</strong> address</li>
<li>#4 DWORD stores 0x24</li>
</ul>
<p><em>Third</em>, we have an allocated memory with PAGE_EXECUTE_READWRITE permission stored in <strong>_Dst</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>_Dst <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)VirtualAlloc((LPVOID)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x248</span>,<span style="color:#ae81ff">0x1000</span>,<span style="color:#ae81ff">0x40</span>);
</span></span><span style="display:flex;"><span>memcpy(_Dst,<span style="color:#f92672">&amp;</span>DAT_00404040,<span style="color:#ae81ff">0x248</span>);
</span></span><span style="display:flex;"><span>(<span style="color:#f92672">*</span>_Dst)(local_8);
</span></span></code></pre></div><p>then <strong>DAT_00404040</strong> is copied to this allocated memory and after that, it&rsquo;s being executed as shellcode with <strong>local_8</strong> taken as a parameter.</p>
<p>Now let&rsquo;s analyze the shellcode, disassemble <strong>DAT_00404040</strong>, and set it as a function in Ghidra so we can decompile it and break it down.</p>
<p><em>First</em>, the shellcode initialized some strings in stack memory</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  local_5c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6d</span>;
</span></span><span style="display:flex;"><span>  local_5b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x73</span>;
</span></span><span style="display:flex;"><span>  local_5a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x76</span>;
</span></span><span style="display:flex;"><span>  local_59 <span style="color:#f92672">=</span> <span style="color:#ae81ff">99</span>;
</span></span><span style="display:flex;"><span>  local_58 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x72</span>;
</span></span><span style="display:flex;"><span>  local_57 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x74</span>;
</span></span><span style="display:flex;"><span>  local_56 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2e</span>;
</span></span><span style="display:flex;"><span>  local_55 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>  local_54 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_53 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_52 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_a4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6b</span>;
</span></span><span style="display:flex;"><span>  local_a3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_a2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x72</span>;
</span></span><span style="display:flex;"><span>  local_a1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6e</span>;
</span></span><span style="display:flex;"><span>  local_a0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_9f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_9e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x33</span>;
</span></span><span style="display:flex;"><span>  local_9d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x32</span>;
</span></span><span style="display:flex;"><span>  local_9c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2e</span>;
</span></span><span style="display:flex;"><span>  local_9b <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>  local_9a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_99 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_98 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_1bc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x66</span>;
</span></span><span style="display:flex;"><span>  local_1bb <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6f</span>;
</span></span><span style="display:flex;"><span>  local_1ba <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x70</span>;
</span></span><span style="display:flex;"><span>  local_1b9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_1b8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6e</span>;
</span></span><span style="display:flex;"><span>  local_1b7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_50 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x66</span>;
</span></span><span style="display:flex;"><span>  local_4f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x72</span>;
</span></span><span style="display:flex;"><span>  local_4e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_4d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x61</span>;
</span></span><span style="display:flex;"><span>  local_4c <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>  local_4b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x66</span>;
</span></span><span style="display:flex;"><span>  local_f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x73</span>;
</span></span><span style="display:flex;"><span>  local_e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6b</span>;
</span></span><span style="display:flex;"><span>  local_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_64 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x66</span>;
</span></span><span style="display:flex;"><span>  local_63 <span style="color:#f92672">=</span> <span style="color:#ae81ff">99</span>;
</span></span><span style="display:flex;"><span>  local_62 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_61 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6f</span>;
</span></span><span style="display:flex;"><span>  local_60 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x73</span>;
</span></span><span style="display:flex;"><span>  local_5f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_5e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_7c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x47</span>;
</span></span><span style="display:flex;"><span>  local_7b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_7a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x74</span>;
</span></span><span style="display:flex;"><span>  local_79 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4d</span>;
</span></span><span style="display:flex;"><span>  local_78 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6f</span>;
</span></span><span style="display:flex;"><span>  local_77 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>  local_76 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x75</span>;
</span></span><span style="display:flex;"><span>  local_75 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_74 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_73 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x46</span>;
</span></span><span style="display:flex;"><span>  local_72 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x69</span>;
</span></span><span style="display:flex;"><span>  local_71 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c</span>;
</span></span><span style="display:flex;"><span>  local_70 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_6f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4e</span>;
</span></span><span style="display:flex;"><span>  local_6e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x61</span>;
</span></span><span style="display:flex;"><span>  local_6d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6d</span>;
</span></span><span style="display:flex;"><span>  local_6c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x65</span>;
</span></span><span style="display:flex;"><span>  local_6b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x41</span>;
</span></span><span style="display:flex;"><span>  local_6a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_80 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x72</span>;
</span></span><span style="display:flex;"><span>  local_7f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x62</span>;
</span></span><span style="display:flex;"><span>  local_7e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p>and these are what we&rsquo;ve got:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>local_5c <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;msvcrt.dll&#34;</span>;
</span></span><span style="display:flex;"><span>local_a4 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kernel32.dll&#34;</span>;
</span></span><span style="display:flex;"><span>local_1bc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fopen&#34;</span>;
</span></span><span style="display:flex;"><span>local_50 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fread&#34;</span>;
</span></span><span style="display:flex;"><span>local_10 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fseek&#34;</span>;
</span></span><span style="display:flex;"><span>local_64 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fclose&#34;</span>;
</span></span><span style="display:flex;"><span>local_7c <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GetModuleFileNameA&#34;</span>;
</span></span><span style="display:flex;"><span>local_80 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rb&#34;</span>;
</span></span></code></pre></div><p>From those strings, i guessed that this shellcode will do dynamic loading of some modules and functions.</p>
<p><em>Next</em>, shellcode copies two data stored in parameter to local variables</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  local_8 <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)<span style="color:#f92672">*</span>param_1;
</span></span><span style="display:flex;"><span>  local_48 <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)param_1[<span style="color:#ae81ff">1</span>];
</span></span></code></pre></div><p>Here <strong>local_8</strong> will hold LoadLibraryA address and <strong>local_48</strong> will hold GetProcAddress address, to make the code clearer, i renamed these two variable in Ghidra to:</p>
<ul>
<li><strong>local_8</strong> =&gt; <strong>LoadLibraryA</strong></li>
<li><strong>local_48</strong> =&gt; <strong>GetProcAddress</strong></li>
</ul>
<p><em>Next</em>, shellcode load msvcrt.dll and kernel32.dll and store their base address to local variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  local_40 <span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>LoadLibraryA)(<span style="color:#f92672">&amp;</span>local_5c);    <span style="color:#75715e">// local_5c = &#34;msvcrt.dll&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  local_88 <span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>LoadLibraryA)(<span style="color:#f92672">&amp;</span>local_a4);    <span style="color:#75715e">// local_a4 = &#34;kernel32.dll&#34;
</span></span></span></code></pre></div><p><em>Next</em>, shellcode will get some function addresses and store them to local variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  local_14 <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>GetProcAddress)(local_88,<span style="color:#f92672">&amp;</span>local_7c);     <span style="color:#75715e">// local_7c = &#34;GetModuleFileNameA&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  local_84 <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>GetProcAddress)(local_40,<span style="color:#f92672">&amp;</span>local_1bc);    <span style="color:#75715e">// local_1bc = &#34;fopen&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  local_a8 <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>GetProcAddress)(local_40,<span style="color:#f92672">&amp;</span>local_10);     <span style="color:#75715e">// local_10 = &#34;fseek&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  local_94 <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>GetProcAddress)(local_40,<span style="color:#f92672">&amp;</span>local_50);     <span style="color:#75715e">// local_50 = &#34;fread&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  local_68 <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>GetProcAddress)(local_40,<span style="color:#f92672">&amp;</span>local_64);     <span style="color:#75715e">// local_64 = &#34;fclose&#34;
</span></span></span></code></pre></div><p>Let&rsquo;s rename those local variable to:</p>
<ul>
<li><strong>local_14</strong> = <strong>GetModuleFileNameA</strong></li>
<li><strong>local_84</strong> = <strong>fopen</strong></li>
<li><strong>local_a8</strong> = <strong>fseek</strong></li>
<li><strong>local_94</strong> = <strong>fread</strong></li>
<li><strong>local_68</strong> = <strong>fclose</strong></li>
</ul>
<p><em>Next</em>, shellcode opened the current executable file(<em>shellcode2.exe_</em>) with <strong>rb</strong> mode</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>GetModuleFileNameA)(<span style="color:#ae81ff">0</span>,local_1b4,<span style="color:#ae81ff">0x104</span>);
</span></span><span style="display:flex;"><span>  local_44 <span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>fopen)(local_1b4,<span style="color:#f92672">&amp;</span>local_80);     <span style="color:#75715e">// local_80 = &#34;rb&#34;
</span></span></span></code></pre></div><p><em>Next</em>, shellcode sets the file position of the stream to offset 0x4e, read 0x26 bytes and stores it in <strong>local_3c</strong> as buffer, then closes the stream</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>fseek)(local_44,<span style="color:#ae81ff">0x4e</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>fread)(local_3c,<span style="color:#ae81ff">0x26</span>,<span style="color:#ae81ff">1</span>,local_44);
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>fclose)(local_44);
</span></span></code></pre></div><p>this is the data shellcode reads:</p>
<p><img src="Snipaste_2022-05-30_20-21-00.jpg" alt="pic2"></p>
<p><em>Next</em>, shellcode copies the last two data stored in the parameter</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  puVar1 <span style="color:#f92672">=</span> param_1[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>  puVar2 <span style="color:#f92672">=</span> param_1[<span style="color:#ae81ff">2</span>];
</span></span></code></pre></div><p><strong>puVar1</strong> will hold DWORD value 0x24 and <strong>puVar2</strong> will hold the <strong>encrypted_data</strong> address, so let&rsquo;s rename it to:</p>
<ul>
<li><strong>puVar1</strong> =&gt; <strong>DWORD_24h</strong></li>
<li><strong>puVar2</strong> =&gt; <strong>encrypted_data</strong></li>
</ul>
<p><em>Next</em>, i guessed the shellcode does the decryption process using xor-loop operation between <strong>encrypted_data</strong> and <strong>local_3c</strong> as xor-key <strong>0x24</strong> times</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  puVar1 <span style="color:#f92672">=</span> (undefined <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>;    <span style="color:#75715e">// puVar1 is loop counters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    encrypted_data[(<span style="color:#66d9ef">int</span>)puVar1] <span style="color:#f92672">=</span> encrypted_data[(<span style="color:#66d9ef">int</span>)puVar1] <span style="color:#f92672">^</span> local_3c[(<span style="color:#66d9ef">int</span>)puVar1];
</span></span><span style="display:flex;"><span>    puVar1 <span style="color:#f92672">=</span> puVar1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (puVar1 <span style="color:#f92672">!=</span> DWORD_24h);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span></code></pre></div><p>Now let&rsquo;s try to decrypt, i extracted encrypted_data from Ghidra to a file using this script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> ghidra.program.model.address <span style="color:#f92672">import</span> AddressSet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max_addr <span style="color:#f92672">=</span> currentSelection<span style="color:#f92672">.</span>getMaxAddress()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>inst <span style="color:#f92672">=</span> getInstructionAt(currentSelection<span style="color:#f92672">.</span>getMinAddress())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>array1 <span style="color:#f92672">=</span> bytearray()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> inst<span style="color:#f92672">.</span>address <span style="color:#f92672">&lt;=</span> max_addr:
</span></span><span style="display:flex;"><span>	array1<span style="color:#f92672">.</span>append(inst<span style="color:#f92672">.</span>getScalar(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>value <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)
</span></span><span style="display:flex;"><span>	inst <span style="color:#f92672">=</span> inst<span style="color:#f92672">.</span>getNext()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Irfan</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Desktop</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">encrypted_data.dat&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> binary_file:
</span></span><span style="display:flex;"><span>	binary_file<span style="color:#f92672">.</span>write(array1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Done&#34;</span>)
</span></span></code></pre></div><p>and i extracted the xor-key to a file using hex editor(HxD), so now we have two files, <strong>encrypted_data.dat</strong> and <strong>xor_key.dat</strong></p>
<p><img src="Snipaste_2022-05-30_21-10-52.jpg" alt="pic3">
<img src="Snipaste_2022-05-30_21-12-17.jpg" alt="pic4"></p>
<p>I made a python script that emulates the decryption process and write the result to a file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>		print(<span style="color:#e6db74">&#34;USAGE: &lt;file1&gt; &lt;file2&gt; &lt;output file&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Read two files as byte arrays</span>
</span></span><span style="display:flex;"><span>	file1_b <span style="color:#f92672">=</span> bytearray(open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>	file2_b <span style="color:#f92672">=</span> bytearray(open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Set the length to be the smaller one</span>
</span></span><span style="display:flex;"><span>	size <span style="color:#f92672">=</span> len(file1_b) <span style="color:#66d9ef">if</span> len(file1_b) <span style="color:#f92672">&lt;</span> len(file2_b) <span style="color:#66d9ef">else</span> len(file2_b)
</span></span><span style="display:flex;"><span>	xord_byte_array <span style="color:#f92672">=</span> bytearray(size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># XOR between the files</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(size):
</span></span><span style="display:flex;"><span>		xord_byte_array[i] <span style="color:#f92672">=</span> file1_b[i] <span style="color:#f92672">^</span> file2_b[i]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># Write the XORd bytes to the output file	</span>
</span></span><span style="display:flex;"><span>	open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">3</span>], <span style="color:#e6db74">&#39;wb&#39;</span>)<span style="color:#f92672">.</span>write(xord_byte_array)
</span></span><span style="display:flex;"><span>	print(<span style="color:#e6db74">&#34;Done...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>run()
</span></span></code></pre></div><p>Opened the result file in HxD:</p>
<p><img src="Snipaste_2022-05-30_21-19-14.jpg" alt="pic5"></p>
<p>We got a very interesting decoded text here, <em>FLAG{STORE-EVERYTHING-ON-THE-STACK</em>.</p>
<p>I checked that string as a flag on their website page and here is the result:</p>
<p><img src="Snipaste_2022-05-30_21-26-47.jpg" alt="pic6"></p>
<p>Yep!, we&rsquo;ve got the <strong>FLAG</strong>.</p>
<p>Challenge source: <a href="https://www.malwaretech.com/challenges/windows-reversing/shellcode2">https://www.malwaretech.com/challenges/windows-reversing/shellcode2</a></p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/posts/malwaretech-chal4/">
                  <span class="button__text">MalwareTech Challenge #4 Write-Ups</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >Â© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
