<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        MalwareTech Challenge #5 Write-Ups ::
        Reversing Stories
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="[ De-virtualization ]# Sometimes malware attempts to hinder reverse engineering by implementing a virtual machine which runs custom bytecode. These challenges are designed to test your ability to reverse engineer &amp;amp; manipulate custom bytecode.
 VM1#Description:
 vm1.exe implements a simple 8-bit virtual machine (VM) to try and stop reverse engineers from retrieving the flag. The VM’s RAM contains the encrypted flag and some bytecode to decrypt it."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/malwaretech-chal6/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MalwareTech Challenge #5 Write-Ups"/>
<meta name="twitter:description" content="[ De-virtualization ]# Sometimes malware attempts to hinder reverse engineering by implementing a virtual machine which runs custom bytecode. These challenges are designed to test your ability to reverse engineer &amp; manipulate custom bytecode.
 VM1#Description:
 vm1.exe implements a simple 8-bit virtual machine (VM) to try and stop reverse engineers from retrieving the flag. The VM’s RAM contains the encrypted flag and some bytecode to decrypt it."/>



<meta property="og:title" content="MalwareTech Challenge #5 Write-Ups" />
<meta property="og:description" content="[ De-virtualization ]# Sometimes malware attempts to hinder reverse engineering by implementing a virtual machine which runs custom bytecode. These challenges are designed to test your ability to reverse engineer &amp; manipulate custom bytecode.
 VM1#Description:
 vm1.exe implements a simple 8-bit virtual machine (VM) to try and stop reverse engineers from retrieving the flag. The VM’s RAM contains the encrypted flag and some bytecode to decrypt it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/malwaretech-chal6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-25T14:47:17+07:00" />
<meta property="article:modified_time" content="2022-06-25T14:47:17+07:00" /><meta property="og:site_name" content="Reversing Stories" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">MalwareTech Challenge #5 Write-Ups</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-06-25
        </span>

        
          
        
      

      


      
    </div>

    

    

    <div class="post-content">
      
      <h2 id="-de-virtualization-">
  [ De-virtualization ]
  <a href="#-de-virtualization-" class="h-anchor" aria-hidden="true">#</a>
</h2>
<blockquote>
<p>Sometimes malware attempts to hinder reverse engineering by implementing a virtual machine which runs custom bytecode. These challenges are designed to test your ability to reverse engineer &amp; manipulate custom bytecode.</p>
</blockquote>
<h3 id="vm1">
  VM1
  <a href="#vm1" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Description:</p>
<blockquote>
<p>vm1.exe implements a simple 8-bit virtual machine (VM) to try and stop reverse engineers from retrieving the flag. The VM’s RAM contains the encrypted flag and some bytecode to decrypt it. Can you figure out how the VM works and write your own to decrypt the flag? A copy of the VM’s RAM has been provided in ram.bin (this data is identical to the ram content of the malware’s VM before execution and contains both the custom assembly code and encrypted flag).</p>
</blockquote>
<p>Rules &amp; Information:</p>
<blockquote>
<ul>
<li>You are not require to run vm1.exe, this challenge is static analysis only.</li>
<li>Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating.</li>
<li>Analysis can be done using the free version of IDA Pro (you don’t need the debugger).</li>
</ul>
</blockquote>
<p>Hi friend, in this challenge we are given 2 files, <strong>vm1.exe</strong> and <strong>ram.bin</strong>. let&rsquo;s start with opened ram.bin in hex editor:</p>
<p><img src="Snipaste_2022-06-25_16-34-45.jpg" alt="pic0"></p>
<p>As stated in the description above, this ram.bin is a copy of the VM&rsquo;s RAM, so for now it is impossible to understand it. Let&rsquo;s move to vm1.exe, <em>detect it easy</em> result:</p>
<p><img src="Snipaste_2022-06-25_15-46-46.jpg" alt="pic1"></p>
<p>It&rsquo;s using C/C++, so i opened Ghidra to disassemble and decompile it. Let&rsquo;s start by analyzing the entrypoint function using Ghidra decompiler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">entry</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  HANDLE hHeap;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>lpText;
</span></span><span style="display:flex;"><span>  DWORD dwFlags;
</span></span><span style="display:flex;"><span>  SIZE_T dwBytes;
</span></span><span style="display:flex;"><span>  MD5 local_94 [<span style="color:#ae81ff">144</span>];
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  MD5<span style="color:#f92672">::</span>MD5(local_94);
</span></span><span style="display:flex;"><span>  dwBytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1fb</span>;
</span></span><span style="display:flex;"><span>  dwFlags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  hHeap <span style="color:#f92672">=</span> GetProcessHeap();
</span></span><span style="display:flex;"><span>  DAT_0040423c <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)HeapAlloc(hHeap,dwFlags,dwBytes);
</span></span><span style="display:flex;"><span>  memcpy(DAT_0040423c,<span style="color:#f92672">&amp;</span>DAT_00404040,<span style="color:#ae81ff">0x1fb</span>);
</span></span><span style="display:flex;"><span>  FUN_004022e0();
</span></span><span style="display:flex;"><span>  lpText <span style="color:#f92672">=</span> MD5<span style="color:#f92672">::</span>digestString(local_94,DAT_0040423c);
</span></span><span style="display:flex;"><span>  MessageBoxA((HWND)<span style="color:#ae81ff">0x0</span>,lpText,<span style="color:#e6db74">&#34;We</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">ve been compromised!&#34;</span>,<span style="color:#ae81ff">0x30</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>  ExitProcess(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>An address allocated heap is stored in <strong>DAT_0040423C</strong>, 0x1FB bytes of data from <strong>DAT_00404040</strong> are copied into it, then that data will be hashed and the hash will be displayed in a messagebox. Let&rsquo;s see what data is in <strong>DAT_00404040</strong>:</p>
<p><img src="Snipaste_2022-06-25_16-24-10.jpg" alt="pic2"></p>
<p>And it turns out that this data is identical to ram.bin, so let&rsquo;s name it <strong>vm_ram</strong>.</p>
<p>This <strong>vm_ram</strong> is copied in <strong>[ DAT_0040423C ]</strong> and there is no processing of this data in this entrypoint function, so it might be done in another function.</p>
<p>Let&rsquo;s analyze <strong>FUN_004022e0</strong> called in this entrypoint function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_004022e0</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  byte bVar1;
</span></span><span style="display:flex;"><span>  uint uVar2;
</span></span><span style="display:flex;"><span>  byte bVar3;
</span></span><span style="display:flex;"><span>  byte local_5;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> (uint)local_5;
</span></span><span style="display:flex;"><span>    bVar1 <span style="color:#f92672">=</span> local_5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    bVar3 <span style="color:#f92672">=</span> local_5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    local_5 <span style="color:#f92672">=</span> local_5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> FUN_00402270((uint)<span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> uVar2),(uint)<span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> (uint)bVar1),<span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> (uint)bVar3));
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> ((uVar2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ok, there is a loop, and <strong>FUN_00402270</strong> is called in it, remember that <strong>DAT_0040423c</strong> is a pointer to <strong>vm_ram</strong> data, and where that data is accessed as 3 parameters for <strong>FUN_00402270</strong>.</p>
<p>From Ghidra decompiler result above, the first and second parameters access the <strong>vm_ram</strong> data in the size of a byte.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> uVar2)         <span style="color:#75715e">// first parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> (uint)bVar1)   <span style="color:#75715e">// second parameter
</span></span></span></code></pre></div><p>But for the third parameter, accessed size is undefined.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> (uint)bVar3)
</span></span></code></pre></div><p>Let&rsquo;s see the assembly code for the above pseudo-code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">MOVZX</span>   <span style="color:#66d9ef">EAX</span>, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">EBP</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#66d9ef">local_5</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MOV</span>     <span style="color:#66d9ef">ECX</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">DAT_0040423c</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MOVZX</span>   <span style="color:#66d9ef">EDX</span>, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ECX</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#66d9ef">EAX</span>*<span style="color:#ae81ff">0x1</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">0xff</span>]
</span></span></code></pre></div><p>In the third line, the accessed size for the third parameter is a byte. So all three parameters both access <strong>vm_ram</strong> with a size of a byte.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// first loop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span>)  <span style="color:#75715e">// 1st parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)  <span style="color:#75715e">// 2nd parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>)  <span style="color:#75715e">// 3rd parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// second loop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>)  <span style="color:#75715e">// 1st parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>)  <span style="color:#75715e">// 2nd parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>)  <span style="color:#75715e">// 3rd parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and so on
</span></span></span></code></pre></div><p>So here in the do-while loop, <strong>FUN_00402270</strong> is called and will read **<strong>vm_ram</strong> data per 3 bytes sequentially starting at offset 0xff, and the loop will breaks when <strong>FUN_00402270</strong> returns zero.</p>
<p>Let&rsquo;s move to analyze <strong>FUN_00402270</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_00402270</span>(<span style="color:#66d9ef">int</span> param_1,<span style="color:#66d9ef">int</span> param_2,undefined param_3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (param_1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> param_2) <span style="color:#f92672">=</span> param_3;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (param_1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    param_1 <span style="color:#f92672">=</span> DAT_0040423c <span style="color:#f92672">+</span> param_2;
</span></span><span style="display:flex;"><span>    DAT_00404240 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)param_1;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (param_1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> param_1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffff00</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    param_1 <span style="color:#f92672">=</span> DAT_0040423c <span style="color:#f92672">+</span> param_2;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> param_2) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)param_1 <span style="color:#f92672">^</span> DAT_00404240;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> CONCAT31((int3)((uint)param_1 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>),<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Because there are no other functions called from this function, this is the last function that needs to be analyzed.</p>
<p>This function performs 3 tasks based on the parameters passed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// task #1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(undefined <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> param_2) <span style="color:#f92672">=</span> param_3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task #2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>param_1 <span style="color:#f92672">=</span> DAT_0040423c <span style="color:#f92672">+</span> param_2;
</span></span><span style="display:flex;"><span>DAT_00404240 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)param_1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// task #3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>param_1 <span style="color:#f92672">=</span> DAT_0040423c <span style="color:#f92672">+</span> param_2;
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(DAT_0040423c <span style="color:#f92672">+</span> param_2) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)param_1 <span style="color:#f92672">^</span> DAT_00404240;
</span></span></code></pre></div><p>And because this function parameter is from vm_ram, i guessed that this function is where VM&rsquo;s custom byte code is executed.</p>
<p>Based on this function, i&rsquo;ll write a python script to emulate the VM, but before that, there is an undefined access size in task #1, and this must be made clear first to emulate with great precision. To do that, let&rsquo;s see the assembly code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">MOV</span>   <span style="color:#66d9ef">ECX</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">DAT_0040423c</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ADD</span>   <span style="color:#66d9ef">ECX</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">EBP</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#66d9ef">param_2</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MOV</span>   <span style="color:#66d9ef">DL</span>, <span style="color:#66d9ef">byte_ptr</span> [<span style="color:#66d9ef">EBP</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#66d9ef">param3</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MOV</span>   <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ECX</span>], <span style="color:#66d9ef">DL</span>
</span></span></code></pre></div><p>Ok, in the fourth line, the accessed size in task #1 is in the size of a byte, and now here&rsquo;s my python script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>file1 <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;ram.bin&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> bytearray(file1<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>file1<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    p1 <span style="color:#f92672">=</span> data[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span>]
</span></span><span style="display:flex;"><span>    p2 <span style="color:#f92672">=</span> data[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span>]
</span></span><span style="display:flex;"><span>    p3 <span style="color:#f92672">=</span> data[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xff</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> p1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        data[p2] <span style="color:#f92672">=</span> p3
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> p1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        p4 <span style="color:#f92672">=</span> data[p2]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> p1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        data[p2] <span style="color:#f92672">=</span> data[p2] <span style="color:#f92672">^</span> p4
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file2 <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;result.bin&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>)
</span></span><span style="display:flex;"><span>file2<span style="color:#f92672">.</span>write(data)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;done!&#34;</span>)
</span></span></code></pre></div><p>Run the script then opened result.bin in hex editors:</p>
<p><img src="Snipaste_2022-06-27_12-10-36.jpg" alt="pic3"></p>
<p>Got an interesting string here that has the flag&rsquo;s format, and i checked it:</p>
<p><img src="Snipaste_2022-06-27_12-17-03.jpg" alt="pic4"></p>
<p>Yep, <em>FLAG{VMS-ARE-FOR-MALWARE}</em> is the <strong>flag</strong>.</p>
<p>Challenge source: <a href="https://www.malwaretech.com/challenges/windows-reversing/vm1">https://www.malwaretech.com/challenges/windows-reversing/vm1</a></p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/posts/malwaretech-chal5/">
                  <span class="button__text">MalwareTech Challenge #5 Write-Ups</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
