<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        MalwareTech Windows Reversing Challenge #7 Write-Ups ::
        Reversing Stories
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="[ Ransomware ]# The goal of ransomware is to encrypt files; fortunately, ransomware developers often ignore the #1 rule of crypto (never roll your own crypto). As a result, it is sometimes possible to recover encrypted files without paying the ransom. These challenges are designed to test your ability to recover ransomware encrypted data.
 Ransomware1#Description:
 The administrator for FlagCorp was using an outdated Windows 7 system and got infected with some ransomware."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/malwaretech-chal7/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MalwareTech Windows Reversing Challenge #7 Write-Ups"/>
<meta name="twitter:description" content="[ Ransomware ]# The goal of ransomware is to encrypt files; fortunately, ransomware developers often ignore the #1 rule of crypto (never roll your own crypto). As a result, it is sometimes possible to recover encrypted files without paying the ransom. These challenges are designed to test your ability to recover ransomware encrypted data.
 Ransomware1#Description:
 The administrator for FlagCorp was using an outdated Windows 7 system and got infected with some ransomware."/>



<meta property="og:title" content="MalwareTech Windows Reversing Challenge #7 Write-Ups" />
<meta property="og:description" content="[ Ransomware ]# The goal of ransomware is to encrypt files; fortunately, ransomware developers often ignore the #1 rule of crypto (never roll your own crypto). As a result, it is sometimes possible to recover encrypted files without paying the ransom. These challenges are designed to test your ability to recover ransomware encrypted data.
 Ransomware1#Description:
 The administrator for FlagCorp was using an outdated Windows 7 system and got infected with some ransomware." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/malwaretech-chal7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-29T13:41:11+07:00" />
<meta property="article:modified_time" content="2022-06-29T13:41:11+07:00" /><meta property="og:site_name" content="Reversing Stories" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">MalwareTech Windows Reversing Challenge #7 Write-Ups</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-06-29
        </span>

        
          
        
      

      


      
    </div>

    

    

    <div class="post-content">
      
      <h2 id="-ransomware-">
  [ Ransomware ]
  <a href="#-ransomware-" class="h-anchor" aria-hidden="true">#</a>
</h2>
<blockquote>
<p>The goal of ransomware is to encrypt files; fortunately, ransomware developers often ignore the #1 rule of crypto (never roll your own crypto). As a result, it is sometimes possible to recover encrypted files without paying the ransom. These challenges are designed to test your ability to recover ransomware encrypted data.</p>
</blockquote>
<h3 id="ransomware1">
  Ransomware1
  <a href="#ransomware1" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Description:</p>
<blockquote>
<p>The administrator for FlagCorp was using an outdated Windows 7 system and got infected with some ransomware. We believe this variant was most likely written by a scriptkiddie due to the fact it was so badly designed it encrypted itself. One of our malware analysts was able to recover the encryption function from memory but doesn’t know much about cryptography. Can you find a way to decrypt flag.txt?</p>
</blockquote>
<p>Rules &amp; Information:</p>
<blockquote>
<ul>
<li>You are not require to run vm1.exe, this challenge is static analysis only.</li>
<li>Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating.</li>
<li>Analysis can be done using the free version of IDA Pro (you don’t need the debugger).</li>
</ul>
</blockquote>
<p>Hi, in this challenge there are several files given, ransomware1.exe_ and a folder named EncryptedFiles.</p>
<p>In the EncryptedFiles folder, there are several files encrypted by this ransomware1.exe_, and stored in 2 subfolders based on the file type, Documents and Pictures.</p>
<p><img src="Snipaste_2022-06-29_14-08-31.jpg" alt="pic1"></p>
<p><img src="Snipaste_2022-06-29_14-09-08.jpg" alt="pic2"></p>
<p>If we look at the file names, the files in Pictures subfolder seem to be JPG files, and a file in Documents subfolder seems to be a TXT file, this is the first important information we can get.</p>
<p>Next, let&rsquo;s take a look into ransomware1.exe_ using <em>detect it easy</em>:</p>
<p><img src="Snipaste_2022-06-29_14-18-09.jpg" alt="pic3"></p>
<p>This ransomware1.exe_ is written using C/C++, so i&rsquo;ll use Ghidra to look at its code starting from its entrypoint function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Ghidra decompiler result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">entry</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  FUN_00401000((LPCSTR)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>  ExitProcess(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nothing interesting here, so let&rsquo;s move into FUN_00401000:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Ghidra decompiler result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* WARNING: Function: _chkstk replaced with injection: alloca_probe */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">FUN_00401000</span>(LPCSTR param_1,<span style="color:#66d9ef">int</span> param_2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  BOOL BVar1;
</span></span><span style="display:flex;"><span>  uint local_1120;
</span></span><span style="display:flex;"><span>  byte local_111c [<span style="color:#ae81ff">4100</span>];
</span></span><span style="display:flex;"><span>  HANDLE local_118;
</span></span><span style="display:flex;"><span>  uint local_114;
</span></span><span style="display:flex;"><span>  HANDLE local_110;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> local_10c [<span style="color:#ae81ff">260</span>];
</span></span><span style="display:flex;"><span>  undefined4 uStack8;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  uStack8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40100d</span>;
</span></span><span style="display:flex;"><span>  _snprintf(local_10c,<span style="color:#ae81ff">0x104</span>,<span style="color:#e6db74">&#34;%s_encrypted&#34;</span>,param_1);
</span></span><span style="display:flex;"><span>  local_110 <span style="color:#f92672">=</span> CreateFileA(param_1,<span style="color:#ae81ff">0x80000000</span>,<span style="color:#ae81ff">0</span>,(LPSECURITY_ATTRIBUTES)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x80</span>,(HANDLE)<span style="color:#ae81ff">0x0</span>);
</span></span><span style="display:flex;"><span>  local_118 <span style="color:#f92672">=</span> CreateFileA(local_10c,<span style="color:#ae81ff">0x40000000</span>,<span style="color:#ae81ff">0</span>,(LPSECURITY_ATTRIBUTES)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0x80</span>,(HANDLE)<span style="color:#ae81ff">0x0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    BVar1 <span style="color:#f92672">=</span> ReadFile(local_110,local_111c,<span style="color:#ae81ff">0x1000</span>,<span style="color:#f92672">&amp;</span>local_114,(LPOVERLAPPED)<span style="color:#ae81ff">0x0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (BVar1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (local_1120 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; local_1120 <span style="color:#f92672">&lt;</span> local_114; local_1120 <span style="color:#f92672">=</span> local_1120 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      local_111c[local_1120] <span style="color:#f92672">=</span> local_111c[local_1120] <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> local_1120 <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x20</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    WriteFile(local_118,local_111c,local_114,<span style="color:#f92672">&amp;</span>local_114,(LPOVERLAPPED)<span style="color:#ae81ff">0x0</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (local_114 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>  CloseHandle(local_110);
</span></span><span style="display:flex;"><span>  CloseHandle(local_118);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, ransomware1.exe_ will open the target file with GENERIC_READ access and param_1 is the name of the target file, then create a new file that uses the name of the target file added with &ldquo;_encrypted&rdquo; string with GENERIC_WRITE access:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>local_110 <span style="color:#f92672">=</span> CreateFileA(param_1,<span style="color:#ae81ff">0x80000000</span>,<span style="color:#ae81ff">0</span>,(LPSECURITY_ATTRIBUTES)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x80</span>,(HANDLE)<span style="color:#ae81ff">0x0</span>);
</span></span><span style="display:flex;"><span>local_118 <span style="color:#f92672">=</span> CreateFileA(local_10c,<span style="color:#ae81ff">0x40000000</span>,<span style="color:#ae81ff">0</span>,(LPSECURITY_ATTRIBUTES)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0x80</span>,(HANDLE)<span style="color:#ae81ff">0x0</span>);
</span></span></code></pre></div><p>next is read the target file with local_111c as its buffer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>BVar1 <span style="color:#f92672">=</span> ReadFile(local_110,local_111c,<span style="color:#ae81ff">0x1000</span>,<span style="color:#f92672">&amp;</span>local_114,(LPOVERLAPPED)<span style="color:#ae81ff">0x0</span>);
</span></span></code></pre></div><p>and this buffer will be encrypted using XOR operation with param_2 as the encryption key:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (local_1120 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; local_1120 <span style="color:#f92672">&lt;</span> local_114; local_1120 <span style="color:#f92672">=</span> local_1120 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    local_111c[local_1120] <span style="color:#f92672">=</span> local_111c[local_1120] <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> local_1120 <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x20</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>then finally this encrypted buffer is written to a file that was created earlier as an encrypted file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>WriteFile(local_118,local_111c,local_114,<span style="color:#f92672">&amp;</span>local_114,(LPOVERLAPPED)<span style="color:#ae81ff">0x0</span>);
</span></span></code></pre></div><p>Now let&rsquo;s focus on the XOR encryption subroutine because the most important thing to be able to decrypt the encrypted files is understanding this subroutine well. Actually, this subroutine is very simple, it just XOR-ing byte per byte of target file data in the buffer with 32 bytes key.</p>
<p>Because this encryption uses a symmetric key and a simple XOR operation, the way to do decryption is to use the same way when doing encryption.</p>
<p>The problem is the key is missing, the key is stored in param_2, right?, now let&rsquo;s look at when FUN_00401000 is called from entrypoint function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>FUN_00401000((LPCSTR)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>param_1 which should hold the target filename and param_2 which should hold the encryption key both are NULL, so the encryption key doesn&rsquo;t exist here, let&rsquo;s start to find it!!!</p>
<p>There are several encrypted JPG files here, and they will be the basic clues to finding the key. A common file usually has its own <a href="https://en.wikipedia.org/wiki/File_format">file format</a>, and usually, files of the same type have <a href="https://en.wikipedia.org/wiki/File_format#File_header">file header</a> that are identical although not 100%. And here&rsquo;s some reference about JPG file format:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/JPEG#Syntax_and_structure">https://en.wikipedia.org/wiki/JPEG#Syntax_and_structure</a></li>
<li><a href="https://github.com/corkami/formats/blob/master/image/jpeg.md">https://github.com/corkami/formats/blob/master/image/jpeg.md</a></li>
<li><img src="JPEGRGB_dissected.jpg" alt="pic5"></li>
</ul>
<p>Here i create a random picture using Microsoft Paint and save it as Untitled.jpg:</p>
<p><img src="Untitled.jpg" alt="pic4"></p>
<p>Now I&rsquo;ll perform a bitwise XOR operation between the first 32 bytes encrypted JPG file with the first 32 bytes Untitled.jpg and save the result in key.bin. Here&rsquo;s the result:</p>
<p>key.bin
<img src="Snipaste_2022-06-30_10-34-56.jpg" alt="pic6"></p>
<p>And then i create this decrypt.py to emulate the encryption/decryption subroutine using key.bin as the key:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># decrypt.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;USAGE: decrypt.py &lt;filename&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file1 <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;key.bin&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>)
</span></span><span style="display:flex;"><span>file2 <span style="color:#f92672">=</span> open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;rb&#34;</span>)
</span></span><span style="display:flex;"><span>dat1 <span style="color:#f92672">=</span> bytearray(file1<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>dat2 <span style="color:#f92672">=</span> bytearray(file2<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>file1<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>file2<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> i <span style="color:#f92672">&lt;</span> len(dat2):
</span></span><span style="display:flex;"><span>    dat2[i] <span style="color:#f92672">^=</span> dat1[i <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file3 <span style="color:#f92672">=</span> open(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;_encrypted&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>), <span style="color:#e6db74">&#34;wb&#34;</span>)
</span></span><span style="display:flex;"><span>file3<span style="color:#f92672">.</span>write(dat2)
</span></span><span style="display:flex;"><span>file3<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;done&#34;</span>)
</span></span></code></pre></div><p>I decrypt flag.txt_encrypted and here&rsquo;s flag.txt as the result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>python decrypt<span style="color:#f92672">.</span>py flag<span style="color:#f92672">.</span>txt_encrypted
</span></span></code></pre></div><p><img src="Snipaste_2022-06-30_11-02-21.jpg" alt="pic7"></p>
<p>Here some words have been properly decrypted so they can be read and the word &ldquo;FLAG&rdquo; following with an open bracket character at the beginning confirms that this is the FLAG.</p>
<p>From the <a href="https://www.malwaretech.com/challenges/windows-reversing/ransomware1">source</a> of this challenge, the FLAG has the following format:</p>
<blockquote>
<p>FLAG{EXAMPLE-FLAG}</p>
</blockquote>
<p>The FLAG only uses char &lsquo;A&rsquo; - &lsquo;Z&rsquo;, &lsquo;{&rsquo;, &lsquo;}&rsquo;, and &lsquo;-&rsquo;, so except that means invalid char. Also because this encryption uses 32 bytes Symmetric-key, that means char at offset 0 and char at offset 32 will be encrypted with the same key-byte, char at offset 1 and char at offset 33 will be encrypted with the same key-byte, and so on, therefore, char at offset 0 and char at offset 32 both should be a valid char, but if not, simply it means that the key-byte used is not correct. I illustrate it like this:</p>
<p><img src="Whiteboard1.jpg" alt="pic8"></p>
<p>Now let&rsquo;s mark the invalid chars in the flag.txt:</p>
<p><img src="Snipaste_2022-06-30_13-31-43.jpg" alt="pic9"></p>
<p>So the key-bytes that are still not correct are in the following offsets:</p>
<ul>
<li>0x0C</li>
<li>0x15</li>
<li>0x17</li>
<li>0x18</li>
<li>0x19</li>
<li>0x1A</li>
<li>0x1B</li>
<li>0x1C
<img src="Snipaste_2022-07-05_14-22-13.jpg" alt="pic9A"></li>
</ul>
<p>Now let&rsquo;s look into the JPG file format, a JPG file always ended with bytes 0xFF 0xD9 as a marker of END_OF_IMAGE, so i&rsquo;ll use this to find the missing key-bytes and confirm the correctness of other key-bytes.</p>
<p>First, here&rsquo;s the list of the last 2 bytes from all encrypted JPG files:</p>
<ul>
<li>Chrysanthemum.jpg_encrypted:
<ol>
<li>0x91, @ 0xD6B20</li>
<li>0x2E, @ 0xD6B21</li>
</ol>
</li>
<li>Desert.jpg_encrypted:
<ol>
<li>0xE4, @ 0xCE873</li>
<li>0x34, @ 0xCE874</li>
</ol>
</li>
<li>Hydrangeas.jpg_encrypted:
<ol>
<li>0x58, @ 0x91552</li>
<li>0xC2, @ 0x91553</li>
</ol>
</li>
<li>Jellyfish.jpg_encrypted:
<ol>
<li>0x12, @ 0xBD614</li>
<li>0x0C, @ 0xBD615</li>
</ol>
</li>
<li>Koala.jpg_encrypted:
<ol>
<li>0xF5, @ 0xBEA1D</li>
<li>0x99, @ 0xBEA1E</li>
</ol>
</li>
<li>Lighthouse.jpg_encrypted:
<ol>
<li>0x72, @ 0x8907A</li>
<li>0xF5, @ 0x8907B</li>
</ol>
</li>
<li>Penguins.jpg_encrypted:
<ol>
<li>0x01, @ 0xBDE69</li>
<li>0x72, @ 0xBDE6A</li>
</ol>
</li>
<li>Tulips.jpg_encrypted:
<ol>
<li>0xA4, @ 0x97956</li>
<li>0x59, @ 0x97957</li>
</ol>
</li>
</ul>
<p>Then i XOR all the last 2 bytes with 0xFF 0xD9 and MOD their offset with 0x20 to get their key-bytes offset:</p>
<ul>
<li>Chrysanthemum.jpg_encrypted:
<ol>
<li>0x6E, @ 0x0</li>
<li>0xF7, @ 0x1</li>
</ol>
</li>
<li>Desert.jpg_encrypted:
<ol>
<li>0x1B, @ 0x13</li>
<li>0xED, @ 0x14</li>
</ol>
</li>
<li>Hydrangeas.jpg_encrypted:
<ol>
<li>0xA7, @ 0x12</li>
<li>0x1B, @ 0x13</li>
</ol>
</li>
<li>Jellyfish.jpg_encrypted:
<ol>
<li>0xED, @ 0x14</li>
<li>0xD5, @ 0x15</li>
</ol>
</li>
<li>Koala.jpg_encrypted:
<ol>
<li>0x0A, @ 0x1D</li>
<li>0x40, @ 0x1E</li>
</ol>
</li>
<li>Lighthouse.jpg_encrypted:
<ol>
<li>0x8D, @ 0x1A</li>
<li>0x2C, @ 0x1B</li>
</ol>
</li>
<li>Penguins.jpg_encrypted:
<ol>
<li>0xFE, @ 0x09</li>
<li>0xAB, @ 0x0A</li>
</ol>
</li>
<li>Tulips.jpg_encrypted:
<ol>
<li>0x5B, @ 0x16</li>
<li>0x80, @ 0x17</li>
</ol>
</li>
</ul>
<p>Apply the result above to key.bin</p>
<p><img src="Snipaste_2022-07-02_16-33-22.jpg" alt="pic10"></p>
<p>Decrypt flag.txt_encrypted again, and here&rsquo;s the result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>python decrypt<span style="color:#f92672">.</span>py flag<span style="color:#f92672">.</span>txt_encrypted
</span></span></code></pre></div><p><img src="Snipaste_2022-07-02_16-40-33.jpg" alt="pic11"></p>
<p>It&rsquo;s getting better, huh?.
But there are still some invalid chars and some chars that don&rsquo;t seem right:</p>
<ul>
<li>@ 0x0C and 0x2C</li>
<li>@ 0x18 and 0x38</li>
<li>@ 0x19 and 0x39</li>
<li>@ 0x1C</li>
<li>@ 0x1F</li>
</ul>
<p>So now i&rsquo;ll use the other segment marker. To do that, i decrypt all encrypted JPG files using the latest key.bin, then try to find the missing segment marker, and did the same thing as the previous END_OF_IMAGE marker.</p>
<p>Finding the missing segment marker is quite simple. The majority of the segment marker is followed by the length of the segment itself, and with that length value, the location of the next segment&rsquo;s marker can be found.</p>
<p>after a while of searching, i got one from decrypted Chrysanthemum.jpg_encrypted at offset 0x218.</p>
<p><img src="Whiteboard2.jpg" alt="pic12"></p>
<p>The offset of this missing marker is in the list of key-bytes offsets i&rsquo;m looking for:</p>
<ul>
<li>0x218 % 0x20 = 0x18</li>
<li>0x219 % 0x20 = 0x19</li>
</ul>
<p>The missing segment marker is located after <em>SOF0 start of frame (baseline jpeg)</em> which is marked with 0xFF 0xC0, so most likely this missing segment is <em>DEFINE_HUFFMAN_TABLE(DHT)</em> with 0xFF 0xC4 as the segment marker.</p>
<p>To get the correct key-bytes at offset 0x18 and 0x19, XOR the encrypted bytes of Chrysanthemum.jpg_encrypted at offset 0x218 and 0x219 with 0xFF 0xC4:</p>
<ul>
<li>0x56 ^ 0xFF = 0xA9</li>
<li>0x17 ^ 0xC4 = 0xD3</li>
</ul>
<p>Put the result above into key.bin:</p>
<p><img src="Snipaste_2022-07-05_16-12-48.jpg" alt="pic17"></p>
<p>And then decrypt flag.txt_encrypted again. Here&rsquo;s the result:</p>
<p><img src="Snipaste_2022-07-04_14-10-23.jpg" alt="pic13"></p>
<p>It&rsquo;s almost perfect, right?.
And now there are 4 char left(3 key-bytes):</p>
<ul>
<li>@ 0x0C and 0x2C</li>
<li>@ 0x1C</li>
<li>@ 0x1F</li>
</ul>
<p>Let&rsquo;s just guess it!</p>
<ol>
<li>Char at 0x0C and 0x2C, both are encrypted using same key-byte, so just focus on one of them. Here, char at 0x0C is &lsquo;F&rsquo; in word &ldquo;MAKFS&rdquo;, and i guessed that the correct word is &ldquo;MAKES&rdquo;, so char at offset 0x0C should be &lsquo;E&rsquo;(0x45).</li>
<li>Char at 0x1C. This char is in word &ldquo;PLAINTE?T&rdquo;, and i guessed that the correct word is &ldquo;PLAINTEXT&rdquo;, so char at 0x1C should be &lsquo;X&rsquo;(0x58) instead of &lsquo;?&rsquo;.</li>
<li>Char at 0x1F. This char is in word &ldquo;CND&rdquo;, and i guessed that the correct word is &ldquo;AND&rdquo;, so char at 0x1F should be &lsquo;A&rsquo;(0x41).</li>
</ol>
<p>XOR all original encrypted bytes in flag.txt_encrypted with its guessed char:</p>
<ul>
<li>(@ 0x0C) 0xC5 ^ 0x45 = 0x80</li>
<li>(@ 0x1C) 0xE0 ^ 0x58 = 0xB8</li>
<li>(@ 0x1F) 0x4E ^ 0x41 = 0x0F</li>
</ul>
<p>Put the result above into key.bin:</p>
<p><img src="Snipaste_2022-07-05_16-07-30.jpg" alt="pic16"></p>
<p>Then decrypt flag.txt_encrypted once again, and here&rsquo;s the decrypted flag.txt:</p>
<p><img src="Snipaste_2022-07-05_12-26-33.jpg" alt="pic14"></p>
<p>It seems complete now, <em>FLAG{XOR-MAKES-KNOWN-PLAINTEXT-AND-FREQUENCY-ANALYSIS-EASY}</em>.
Let&rsquo;s check it out:</p>
<p><img src="Snipaste_2022-07-05_12-31-22.jpg" alt="pic15"></p>
<p>Yeah, we&rsquo;ve got the FLAG!.</p>
<p>And as a bonus, here&rsquo;s all decrypted JPG image:</p>
<p>Chrysanthemum-min.jpg
<img src="Chrysanthemum-min.jpg" alt="1"></p>
<p>Desert-min.jpg
<img src="Desert-min.jpg" alt="2"></p>
<p>Hydrangeas-min.jpg
<img src="Hydrangeas-min.jpg" alt="3"></p>
<p>Jellyfish-min.jpg
<img src="Jellyfish-min.jpg" alt="4"></p>
<p>Koala-min.jpg
<img src="Koala-min.jpg" alt="5"></p>
<p>Lighthouse-min.jpg
<img src="Lighthouse-min.jpg" alt="6"></p>
<p>Penguins-min.jpg
<img src="Penguins-min.jpg" alt="7"></p>
<p>Tulips-min.jpg
<img src="Tulips-min.jpg" alt="8"></p>
<p>Challenge source: <a href="https://www.malwaretech.com/challenges/windows-reversing/ransomware1">https://www.malwaretech.com/challenges/windows-reversing/ransomware1</a></p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/posts/flareon9-writeup/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Flare-On 9 Write-Up</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/posts/malwaretech-chal6/">
                  <span class="button__text">MalwareTech Windows Reversing Challenge #6 Write-Ups</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2023 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
