<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        MalwareTech Windows Reversing Challenge #4 Write-Ups ::
        Reversing Stories
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="[ Shellcode ]# Position independent code (AKA Shellcode) is assembly code which can simply be copied to a memory location and run. Due to the lack of need for complex loading &amp;amp; initialization, it is popular for many tasks such as code injection. These challenges are designed to test your ability to reverse engineer malware shellcode.
 Shellcode1#Hello friend, in this challenge we are given a PE file named shellcode1."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/malwaretech-chal4/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MalwareTech Windows Reversing Challenge #4 Write-Ups"/>
<meta name="twitter:description" content="[ Shellcode ]# Position independent code (AKA Shellcode) is assembly code which can simply be copied to a memory location and run. Due to the lack of need for complex loading &amp; initialization, it is popular for many tasks such as code injection. These challenges are designed to test your ability to reverse engineer malware shellcode.
 Shellcode1#Hello friend, in this challenge we are given a PE file named shellcode1."/>



<meta property="og:title" content="MalwareTech Windows Reversing Challenge #4 Write-Ups" />
<meta property="og:description" content="[ Shellcode ]# Position independent code (AKA Shellcode) is assembly code which can simply be copied to a memory location and run. Due to the lack of need for complex loading &amp; initialization, it is popular for many tasks such as code injection. These challenges are designed to test your ability to reverse engineer malware shellcode.
 Shellcode1#Hello friend, in this challenge we are given a PE file named shellcode1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/malwaretech-chal4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-24T13:14:20+07:00" />
<meta property="article:modified_time" content="2022-05-24T13:14:20+07:00" /><meta property="og:site_name" content="Reversing Stories" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">MalwareTech Windows Reversing Challenge #4 Write-Ups</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-05-24
        </span>

        
          
        
      

      


      
    </div>

    

    

    <div class="post-content">
      
      <h2 id="-shellcode-">
  [ Shellcode ]
  <a href="#-shellcode-" class="h-anchor" aria-hidden="true">#</a>
</h2>
<blockquote>
<p>Position independent code (AKA Shellcode) is assembly code which can simply be copied to a memory location and run. Due to the lack of need for complex loading &amp; initialization, it is popular for many tasks such as code injection. These challenges are designed to test your ability to reverse engineer malware shellcode.</p>
</blockquote>
<h3 id="shellcode1">
  Shellcode1
  <a href="#shellcode1" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Hello friend, in this challenge we are given a PE file named <em>shellcode1.exe_</em> .</p>
<p>Description of this challenge:</p>
<blockquote>
<p>shellcode1.exe contains a flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>Rules &amp; Information:</p>
<blockquote>
<ul>
<li>You are not require to run shellcode1.exe, this challenge is static analysis only.</li>
<li>Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating.</li>
<li>Analysis can be done using the free version of IDA Pro (you don’t need the debugger).</li>
</ul>
</blockquote>
<p><em>detect it easy</em> result:</p>
<p><img src="Snipaste_2022-05-24_13-36-40.jpg" alt="pic1"></p>
<p>Ghidra decompilation result of entrypoint function:</p>
<p><img src="Snipaste_2022-05-24_13-50-34.jpg" alt="pic2"></p>
<p>Here we get some interesting points:</p>
<ul>
<li>Suspicious data ==&gt; <strong>DAT_00404040</strong></li>
<li>VirtualAlloc() with its memory protection set to 0x40(PAGE_EXECUTE_READWRITE), then <strong>DAT_00404068</strong> is copied to that allocated memory, and executed ==&gt; shellcode execution pattern</li>
</ul>
<p>Let&rsquo;s analyze <strong>DAT_00404040</strong> first:</p>
<p><img src="Snipaste_2022-05-24_14-26-02.jpg" alt="pic3"></p>
<p>It looks like this data is encrypted, so there is nothing we can get from this data, just skip it for now.</p>
<p>Let&rsquo;s analyze <strong>DAT_00404068</strong>:</p>
<p><img src="Snipaste_2022-05-24_14-31-50.jpg" alt="pic4"></p>
<p>From the pattern of how <strong>DAT_00404068</strong> will be processed and used by the program, we can conclude that this is a <em>shellcode</em>. So we can try to disassemble it:</p>
<p><img src="Snipaste_2022-05-24_14-44-42.jpg" alt="pic5"></p>
<p>Simply put, this shellcode takes one parameter and processes it by performing bitwise operation <em>ROL</em> byte by byte.</p>
<p>First question is:</p>
<ul>
<li>what kind of data is taken as the parameter?</li>
</ul>
<p>The parameter is stored in the ESI register, so let&rsquo;s trace it!</p>
<p><img src="Snipaste_2022-05-24_15-07-33.jpg" alt="pic6"></p>
<p>Here Ghidra decompiler defines the called shellcode takes no parameters, this is because Ghidra recognizes this program as an x86 PE, and x86 calling conventions store parameters in stack memory, whereas we already know this shellcode uses ESI registers to store its parameters(similar to x64 calling conventions that use registers to store parameters).</p>
<p>So now we have to see the assembly code in Ghidra disassembler:</p>
<p><img src="Snipaste_2022-05-24_17-14-51.jpg" alt="pic7"></p>
<p>We can see that ESI initialized with value in <strong>local_8</strong>, and the next question is:</p>
<ul>
<li>what kind of data is stored in <strong>local_8</strong>?</li>
</ul>
<p>Back to Ghidra decompiler:</p>
<p><img src="Snipaste_2022-05-24_20-40-10.jpg" alt="pic8"></p>
<p>local_8 stores the address of allocated heap memory, and this allocated heap memory stores a pointer to <strong>DAT_00404040</strong> and the length of <strong>DAT_00404040</strong>.</p>
<p><strong>DAT_00404040</strong> is encrypted data and <strong>DAT_00404068</strong> is shellcode that will process it, so it looks like this shellcode is the decryptor function for the encrypted data(DAT_00404040).</p>
<p>Let&rsquo;s try to confirm it by writing a Ghidra script that emulates the decryptor function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> ghidra.program.model.address <span style="color:#f92672">import</span> AddressSet
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>rol <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> val, r_bits, max_bits: \
</span></span><span style="display:flex;"><span>    (val <span style="color:#f92672">&lt;&lt;</span> r_bits<span style="color:#f92672">%</span>max_bits) <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>max_bits<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> \
</span></span><span style="display:flex;"><span>    ((val <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>max_bits<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&gt;&gt;</span> (max_bits<span style="color:#f92672">-</span>(r_bits<span style="color:#f92672">%</span>max_bits)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>():
</span></span><span style="display:flex;"><span>    memory <span style="color:#f92672">=</span> currentProgram<span style="color:#f92672">.</span>getMemory()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> currentSelection <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> currentSelection<span style="color:#f92672">.</span>isEmpty():
</span></span><span style="display:flex;"><span>		print <span style="color:#e6db74">&#34;Use your mouse to highlight some data to ROL&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	addr_itter <span style="color:#f92672">=</span> currentSelection<span style="color:#f92672">.</span>getAddresses(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> addr <span style="color:#f92672">in</span> addr_itter:	
</span></span><span style="display:flex;"><span>		setByte(addr, rol(getByte(addr), <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>run()
</span></span></code></pre></div><p>Highlight the encrypted data, run the script, and here is the result:</p>
<p><img src="Snipaste_2022-05-24_23-25-51.jpg" alt="pic9"></p>
<p>Now let&rsquo;s change the data type to string:</p>
<p><img src="Snipaste_2022-05-24_23-40-51.jpg" alt="pic10"></p>
<p>We&rsquo;ve got a very interesting string here, let&rsquo;s try to check whether this <em>&ldquo;FLAG{SHELLCODE-ISNT-JUST-FOR-EXPLOITS}&rdquo;</em> is the <strong>FLAG</strong> or not before continuing the analysis</p>
<p><img src="Snipaste_2022-05-24_23-48-07.jpg" alt="pic11"></p>
<p>Yeeepp, that string is the <strong>FLAG</strong>.</p>
<p>Challenge source: <a href="https://www.malwaretech.com/challenges/windows-reversing/shellcode1">https://www.malwaretech.com/challenges/windows-reversing/shellcode1</a></p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/posts/malwaretech-chal5/">
                  <span class="button__icon">←</span>
                  <span class="button__text">MalwareTech Windows Reversing Challenge #5 Write-Ups</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/posts/malwaretech-chal3/">
                  <span class="button__text">MalwareTech Windows Reversing Challenge #3 Write-Ups</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Reversing Stories</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2023 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
